version: '3.8'

services:

  gitlab:
    image: gitlab/gitlab-ce:16.11.10-ce.0
    container_name: gitlab
    hostname: gitlab.kewel.local
    ports:
      - "8080:80"
      - "4443:443"
      - "2222:22"
    volumes:
      - ./gitlab-config:/etc/gitlab
      - ./gitlab-logs:/var/log/gitlab
      - ./gitlab-data:/var/opt/gitlab
    extra_hosts:
      - "jenkins.kewel.local:172.31.14.7"
    networks:
      - devnet

    restart: unless-stopped


  jenkins:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jenkins
    ports:
      - "8081:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - ./certs/gitlab.crt:/usr/local/share/ca-certificates/gitlab.crt
      - ./logs/shared:/shared  # Dossier partagé pour les rapports
      - /var/run/docker.sock:/var/run/docker.sock
    extra_hosts:
      - "gitlab.kewel.local:172.31.14.7"
    networks:
      - devnet
    restart: unless-stopped
    environment:
      # Optimisations JVM Jenkins
      - JAVA_OPTS=-Xmx2048m -Xms512m -XX:MaxMetaspaceSize=256m
      - JENKINS_OPTS=--sessionTimeout=1440
      # - JENKINS_URL=https://jenkins.kewel.local

  postgres:
    image: postgres:15-alpine
    container_name: sonardb
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - sonardb_data:/var/lib/postgresql/data
    networks:
      - devnet  # AJOUTÉ: réseau manquant

    restart: unless-stopped
    # Configuration PostgreSQL optimisée
    command: >
      postgres
      -c shared_buffers=128MB
      -c effective_cache_size=512MB
      -c maintenance_work_mem=32MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100

  sonarqube:
    image: sonarqube:9.9.8-community
    container_name: SonarQube
    depends_on:
      - postgres
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://${SONAR_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - SONAR_JDBC_USERNAME=${POSTGRES_USER}
      - SONAR_JDBC_PASSWORD=${POSTGRES_PASSWORD}
      - SONAR_WEB_JAVAOPTS=-Xmx1024m -Xms256m
    ports:
      - "9000:9000"
    volumes:
      - sonarqube_conf:/opt/sonarqube/conf
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
      - ./logs/shared:/shared
    networks:
      - devnet

    restart: unless-stopped

  trivy:
    image: aquasec/trivy:latest
    container_name: trivy
    entrypoint: tail -f /dev/null   #demarré en long-running

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./trivy-cache:/root/.cache   # Cache pour Trivy
      - ./logs/shared:/shared
    networks:
      - devnet

    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.7
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.authc.api_key.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - logger.org.elasticsearch.ingest=DEBUG
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - devnet  # Important pour que les outils de sécurité puissent envoyer des logs
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.7
    container_name: kibana
    volumes:
      - ./config/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    ports:
      - "5601:5601"
    networks:
      - devnet
    depends_on:
      - elasticsearch
    restart: unless-stopped
    environment:
      - NODE_OPTIONS=--max-old-space-size=1024
    env_file:
      - .env
        
  # APM Server
  apm-server:
    image: docker.elastic.co/apm/apm-server:7.17.7
    container_name: apm-server
    ports:
      - "8200:8200"
    environment:
      - ELASTIC_USERNAME=${ELASTIC_USERNAME}
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    command: >
      apm-server -e
        -E apm-server.host=0.0.0.0:8200
        -E apm-server.rum.enabled=true
        -E apm-server.rum.event_rate.limit=300
        -E apm-server.rum.event_rate.lru_size=1000
        -E apm-server.rum.allow_origins=["*"]
        -E apm-server.rum.library_pattern="node_modules|bower_components|~"
        -E apm-server.rum.exclude_from_grouping="^/webpack"
        -E apm-server.rum.source_mapping.enabled=true
        -E apm-server.rum.source_mapping.cache.expiration=5m
        -E output.elasticsearch.hosts=["http://elasticsearch:9200"]
        -E output.elasticsearch.username=${ELASTIC_USERNAME}
        -E output.elasticsearch.password=${ELASTIC_PASSWORD}
        -E setup.kibana.host=kibana:5601
    depends_on:
      - elasticsearch
      - kibana
    networks:
      - devnet

  filebeat:
    build:
      context: ./config/filebeat
      dockerfile: Dockerfile
    container_name: filebeat
    user: root  # Nécessaire pour accéder aux logs montés
    command: ["filebeat", "-e", "-d", "publish"]
    volumes:
      #- ./config/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      # On mappe le même dossier hôte, en lecture seule pour la sécurité
      - ./logs/shared:/pipeline-reports:ro
    depends_on:
      - elasticsearch
      - kibana
    networks:
      - devnet
    restart: unless-stopped
    env_file:
      - .env


# Option: optional metricbeat if you want infra metrics
  metricbeat:
    build:
      context: ./config/metricbeat
      dockerfile: Dockerfile
    container_name: metricbeat
    user: root  # Nécessaire pour accéder aux métriques système
    command: ["metricbeat", "-e"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - elasticsearch
      - kibana
    networks:
      - devnet
    restart: unless-stopped
    env_file:
      - .env

volumes:
  gitlab-config:
  gitlab-logs:
  gitlab-data:
  jenkins_home:
  dc-data:
  dc-report:
  sonardb_data:
  sonarqube_conf:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_extensions:
  trivy-cache:
  es_data:

networks:
  devnet:
    external: true

